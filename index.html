<!DOCTYPE html>
<html lang="cs">
  <head>
      <meta charset="UTF-8">
      <title>MyVoice V2</title>
      <link rel="stylesheet" type="text/css" href="./style.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body>
  <header>
      Online stream:
      <br>
      <button id="stop-button">Stop</button>
      <button id="start-button">Start</button>
      <br>
      <input type="range" min="0" max="1" step="any" id="threshold">
      <div id="thresh"></div>
  </header>
  <div class="content">
    <div id="scrollable">
        <div id="commands"></div>
    </div>
  </div>
  <footer>
          <div id="lastCommand"></div>
          <div>
              <svg id="detector" width="100" height="100">
                  <circle cx="50" cy="50" r="40"
                          stroke="black" stroke-width="4"/>
                  Sorry, your browser does not support inline SVG.
              </svg>
          </div>
      </footer>
  </body>

  <script>
      var renderer = require('./renderer.js');
      var config = require('./config').config;

      document.getElementById("threshold").value = config.fsm.threshold;
      document.getElementById("thresh").innerText = "Hodnota: " + document.getElementById("threshold").value;
      document.getElementById("threshold").addEventListener("change", function () {
          document.getElementById("thresh").innerText = "Hodnota: " + document.getElementById("threshold").value;
      });

      document.getElementById('stop-button').addEventListener('click', function () {
          renderer.stopRecording();
      });
      document.getElementById('start-button').addEventListener('click', function () {
          renderer.startRecording();
      });

      var controller_1 = require('./Controllers/MainController').MainController;
      var controller = new controller_1();
      controller.updateGUI()

      var detector = document.getElementById("detector");
      detector.setAttribute("fill", "#660000")

      var store_1 = require('electron-store');
      var store = new store_1();

      function getNtx() {
          const got = require("got");
          var domain = store.get("nanogrid.domain");
          var token = store.get("nanogrid.access_token");
          (async() => {
              try {
                  const response = await got.post(domain + "store/ntx-token", {
                      json: true,
                      headers: {"Authorization" : "Bearer " + token},
                      body: {
                          "id":"ntx.v2t.engine.EngineService/cz/voice-control/v2t",
                          "label":"v2t"
                      }
                  });
                  store.set("nanogrid.ntx_token", response.body.ntxToken);
              } catch (error) {
                  //display error to user
                  console.log(error);
              }
          })();
      }

      function login() {
          var domain = store.get("nanogrid.domain");
          var username = store.get("nanogrid.username");
          var password = store.get("nanogrid.password");
          if(store.get("nanogrid.domain") != "" && store.get("nanogrid.username") != "" && store.get("nanogrid.password") != "") {
              const got = require("got");

              (async() => {
                  try {
                      const response = await got.post(domain + "login/access-token", {
                          json: true,
                          body: {
                              "username":username,
                              "password":password
                          }
                      });
                      store.set("nanogrid.access_token", response.body.accessToken);
                      getNtx();
                  } catch (error) {
                      //display error
                      console.log(error);
                  }
              })();
          }
      }

      login()
  </script>
</html>
